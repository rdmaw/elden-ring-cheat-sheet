const key="er",D="default",root=document.documentElement,def={[D]:{data:{},col:{}}};let A=localStorage.getItem("current")||D,p=initProfile();function initProfile(){try{const e=JSON.parse(localStorage.getItem(key))??def;return e[D]={...def[D],...e[D]},localStorage.setItem(key,JSON.stringify(e)),e}catch(e){return console.error("Error initializing profile:",e),def}}const mgr={get:()=>p[A]||p[D],setCl(e,t){e&&(p[A]||(p[A]={data:{},col:{}}),t?p[A].data[e]=1:delete p[A].data[e],localStorage.setItem(key,JSON.stringify(p)))},setCol(e,t){e&&(p[A]||(p[A]={data:{},col:{}}),p[A].col||(p[A].col={}),t?delete p[A].col[e]:p[A].col[e]=1,localStorage.setItem(key,JSON.stringify(p)))},setBatch(e){e?.length&&(p[A]||(p[A]={data:{},col:{}}),p[A].col||(p[A].col={}),e.forEach(({id:e,expanded:t})=>{e&&(t?delete p[A].col[e]:p[A].col[e]=1)}),localStorage.setItem(key,JSON.stringify(p)))},col(){return this.get().col||{}}};function restoreCheckboxes(){const{data:e}=mgr.get();document.querySelectorAll('input[type="checkbox"]').forEach(t=>{const o=!!e[t.id];t.checked=o,t.closest("li").classList.toggle("c",o)})}function calculateTotals(){const e=document.querySelector('input[type="checkbox"]');if(!e)return;const t=e.id.charAt(0),o=document.getElementById(`${t}-ot`);if(!o)return;const r=document.querySelectorAll(`span[id^="${t}-t"]`),n=Array.from(document.querySelectorAll('input[type="checkbox"]')).reduce((e,t)=>{const o=t.id.match(/^[wnqmbaerhskcp](\d+)-/)[1];return e.has(o)?e.get(o).push(t):e.set(o,[t]),e},new Map);let a=0,c=0;r.forEach(e=>{const o=e.id.match(/t(\d+)$/)[1],r=document.getElementById(`${t}-nt${o}`),l=n.get(o)||[],s=l.filter(e=>e.checked).length,i=l.length,d=i?s===i?"DONE":`${s}/${i}`:"0/0",u=s===i&&i>0;[e,r].forEach(e=>{e&&(e.classList.remove("d"),e.textContent=d,u&&e.classList.add("d"))}),a+=s,c+=i}),o.classList.remove("d"),o.textContent=c?a===c?"DONE":`${a}/${c}`:"0/0",a===c&&c>0&&o.classList.add("d")}document.addEventListener("change",e=>{if(e.target.matches('input[type="checkbox"]')){const t=e.target,o=t.checked;t.closest("li").classList.toggle("c",o),mgr.setCl(t.id,t.checked),calculateTotals()}}),window.addEventListener("pageshow",e=>{e.persisted&&window.location.reload()}),document.addEventListener("DOMContentLoaded",()=>{restoreCheckboxes(),calculateTotals(),window.addEventListener("storage",e=>{if(e.key===key||"current"===e.key)try{e.key===key?p=JSON.parse(e.newValue):"current"===e.key&&(A=e.newValue||D,s?.()),restoreCheckboxes(),calculateTotals()}catch(e){console.error("Error syncing profile:",e)}else if("h"===e.key){const t="1"===e.newValue;root.classList.toggle("hide",t),x&&x.setAttribute("aria-pressed",t?"true":"false")}});const e=document.querySelectorAll('a[href^="http"]');for(let t=0,o=e.length;t<o;t++){e[t].target="_blank"}const t=document.getElementById("theme"),o=document.getElementById("cb");if(t&&(t.value=localStorage.getItem("t")||"l",t.addEventListener("change",()=>{const e="d"===t.value;root.classList.toggle("dark",e),localStorage.setItem("t",t.value)})),o){const e=["pro","deu","tri","ach"],t=()=>{const t=o.value;root.classList.remove(...e),"0"!==t&&root.classList.add(t),localStorage.setItem("cb",t)};o.value=localStorage.getItem("cb")||"0",t(),o.addEventListener("change",t)}const r=document.getElementById("profile"),n=document.getElementById("add"),a=document.getElementById("edit"),c=document.getElementById("ngp"),l=document.getElementById("del");function s(){r&&(r.innerHTML="",r.add(new Option("Default",D)),Object.keys(p).sort().filter(e=>e!==D).forEach(e=>r.add(new Option(e,e))),r.value=A)}s(),r?.addEventListener("change",()=>{const e=r.value||D;A=e,e===D?localStorage.removeItem("current"):localStorage.setItem("current",e),p[e]||(p[e]={data:{},col:{}})}),n?.addEventListener("click",()=>{const e=prompt("Enter a name for your profile:")?.trim();e&&("default"===e.toLowerCase()||p[e]?alert("default"===e.toLowerCase()?"Profile name cannot be default.":"Profile already exists."):(p[e]={data:{},col:{}},A=e,localStorage.setItem(key,JSON.stringify(p)),localStorage.setItem("current",e),r.value=e,s()))}),a?.addEventListener("click",()=>{const e=r.value;if(e===D)return void alert("Cannot edit default profile.");const t=prompt(`Enter a new name for "${e}":`,e)?.trim();if(!t||t===e)return;if("default"===t.toLowerCase()||p[t])return void alert("default"===t.toLowerCase()?"Cannot use default as profile name.":"Profile already exists.");const o=p[e];delete p[e],p[t]=o,A=t,localStorage.setItem(key,JSON.stringify(p)),localStorage.setItem("current",t),s()}),c?.addEventListener("click",()=>{const e=r.value;if(!confirm("Starting NG+ will reset all current progress in the Walkthrough, Questlines, Bosses and New Game+ sheets."))return;const t=["w","n","q","b","p"],o=Object.entries(p[e].data).reduce((e,[o,r])=>(t.includes(o.charAt(0))||(e[o]=r),e),{});p[e].data=o,localStorage.setItem(key,JSON.stringify(p))}),l?.addEventListener("click",()=>{const e=r.value;if(confirm(`Are you sure you want to ${e===D?"reset the default profile":`delete "${e}"`}?`))if(e===D)p[D]={data:{},col:{}},localStorage.setItem(key,JSON.stringify(p));else{delete p[e],localStorage.setItem(key,JSON.stringify(p)),e===A&&(A=D,localStorage.removeItem("current"));const t=r.querySelector(`option[value="${e}"]`);t?.remove(),r.value=A}});const i=document.getElementById("imp-f"),d=document.getElementById("exp-f"),u=document.getElementById("imp-c"),m=document.getElementById("exp-c");function g(){return{current:A,[key]:p}}function f(e){if(!e?.[key]?.[D])throw new Error("Invalid profile data.");confirm("Importing a new profile will overwrite all current data.")&&(localStorage.setItem(key,JSON.stringify(e[key])),p=e[key],e.current&&(A=e.current,localStorage.setItem("current",A)),s(),alert("Successfully imported profile data."))}if(i){const e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",i.after(e),i.addEventListener("click",()=>e.click()),e.addEventListener("change",async t=>{const o=t.target.files[0];if(o){try{const e=await o.text();f(JSON.parse(e))}catch(t){alert("Invalid profile data."),console.error(t)}e.value=""}})}d?.addEventListener("click",()=>{try{const e=new Blob([JSON.stringify(g(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download="elden-ring-cheat-sheet.json",o.click(),URL.revokeObjectURL(t)}catch(e){alert("Error exporting file."),console.error(e)}}),u?.addEventListener("click",async()=>{try{const e=await navigator.clipboard.readText();f(JSON.parse(e))}catch(e){alert("Invalid clipboard data."),console.error(e)}}),m?.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(JSON.stringify(g(),null,2)),alert("Profile data copied to clipboard.")}catch(e){alert("Error copying to clipboard."),console.error(e)}});const y=document.getElementById("menu"),E=document.getElementById("sidebar"),h=E.querySelector(".close");function v(){"true"===E.ariaHidden?(E.ariaHidden="false",y.ariaExpanded="true",E.removeAttribute("inert")):(y.focus({preventScroll:!0}),E.ariaHidden="true",y.ariaExpanded="false",E.setAttribute("inert",""))}y.addEventListener("click",v),h.addEventListener("click",v),document.addEventListener("keydown",e=>{const t=document.activeElement;if(!("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName))switch(e.key.toLowerCase()){case"escape":"false"===E.ariaHidden&&v();break;case"q":e.ctrlKey||e.metaKey||(e.preventDefault(),v(),h.focus());break;case"/":if(!e.ctrlKey&&!e.metaKey){e.preventDefault();const t=document.getElementById("search");t&&t.focus()}break;case"h":if(!e.ctrlKey&&!e.metaKey){e.preventDefault();const t=document.getElementById("hide");t&&t.click()}}});const k=document.getElementById("up");if(k){const e=()=>{const e=window.scrollY>500;k.classList.toggle("show",e),k.setAttribute("aria-hidden",e?"false":"true")};window.addEventListener("scroll",e,{passive:!0}),e(),k.addEventListener("click",()=>{window.scrollTo({top:0}),y?.focus()})}const L=document.querySelectorAll(".col"),S=document.getElementById("exp-a"),I=document.getElementById("col-a"),w=new Map;for(const e of L){const t=e.getAttribute("aria-controls"),o=document.getElementById(t);if(!o)continue;w.set(e,o);const r=!!mgr.col()[t];e.ariaExpanded=!r,o.classList.toggle("f",r),e.addEventListener("click",()=>{const r="true"!==e.ariaExpanded;e.ariaExpanded=r,o.classList.toggle("f",!r),mgr.setCol(t,r)})}document.querySelector("style[data-c]")?.remove();const b=e=>{const t=[];w.forEach((o,r)=>{const n=r.getAttribute("aria-controls");r.ariaExpanded=e,o.classList.toggle("f",!e),t.push({id:n,expanded:e})}),mgr.setBatch(t)};S?.addEventListener("click",()=>b(!0)),I?.addEventListener("click",()=>b(!1));const x=document.getElementById("hide");if(x){const e="1"===localStorage.getItem("h");root.classList.toggle("hide",e),x.setAttribute("aria-pressed",e?"true":"false"),x.addEventListener("click",()=>{const e=!root.classList.contains("hide");root.classList.toggle("hide",e),localStorage.setItem("h",e?"1":"0"),x.setAttribute("aria-pressed",e?"true":"false")})}const B=document.getElementById("search");B&&B.addEventListener("input",e=>function(e){const t=[...document.querySelectorAll("main h3")],o=e.toLowerCase().trim();if(!o)return void document.querySelectorAll("main h3, main li").forEach(e=>e.style.display="");const r=o.split(/\s+/),n=new Map,a=e=>(n.has(e)||n.set(e,r.every(t=>e.includes(t))),n.get(e));for(const e of t){const t=e.nextElementSibling;if(!t)continue;const o=a(e.textContent.toLowerCase());let r=o;const n=t.children;if(o)e.style.display="",t.querySelectorAll("li").forEach(e=>e.style.display="");else{for(const e of n){let t=a(e.textContent.toLowerCase());if(t)e.querySelectorAll("ul li").forEach(e=>{e.style.display=""});else{const o=e.querySelectorAll("ul li");for(const e of o)a(e.textContent.toLowerCase())?(e.style.display="",t=!0):e.style.display="none"}e.style.display=t?"":"none",r||=t}e.style.display=r?"":"none"}}}(e.target.value))});
